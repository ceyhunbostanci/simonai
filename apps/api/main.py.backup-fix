"""
Simon AI Agent Studio - Orchestrator API
FastAPI backend for AI agent orchestration
Version: 3.1.0
"""

from contextlib import asynccontextmanager
from fastapi import FastAPI, Request
from app.metrics import setup_metrics
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
import uvicorn
import logging
import sys
from datetime import datetime

from app.config import settings
from app.routers import chat, health, models, auth, agent_studio, computer_use, audit
from app.middleware.logging import RequestLoggingMiddleware
from app.middleware.error_handler import ErrorHandlerMiddleware

# Database
from app.database.connection import init_db, check_db_connection

# Configure logging
logging.basicConfig(
    level=getattr(logging, settings.LOG_LEVEL),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)

logger = logging.getLogger(__name__)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Lifecycle manager for startup/shutdown"""
    # Startup
    logger.info("ÄŸÅ¸Å¡â‚¬ Simon AI Orchestrator starting...")
    logger.info(f"Environment: {settings.ENVIRONMENT}")
    logger.info(f"Debug mode: {settings.DEBUG}")
    
    # Initialize database
    if settings.DATABASE_URL:
        logger.info("Initializing database...")
        init_db()
        
        if check_db_connection():
            logger.info("Ã¢Å“â€¦ Database connected")
        else:
            logger.warning("Ã¢Å¡Â Ã¯Â¸Â  Database connection failed")
    else:
        logger.warning("Ã¢Å¡Â Ã¯Â¸Â  DATABASE_URL not configured - running without persistence")
    
    yield
    
    # Shutdown
    logger.info("ÄŸÅ¸â€˜â€¹ Simon AI Orchestrator shutting down...")


# Create FastAPI app
app = FastAPI(

# Metrics setup
setup_metrics(app)
    title="Simon AI Agent Studio",
    description="Kurumsal seviye AI Agent orkestrasyon platformu",
    version="3.1.0",
    docs_url="/docs",
    redoc_url="/redoc",
    lifespan=lifespan,
)

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Custom middleware
app.add_middleware(RequestLoggingMiddleware)
app.add_middleware(ErrorHandlerMiddleware)

# Include routers
app.include_router(health.router, tags=["Health"])
app.include_router(auth.router, prefix="/api/auth", tags=["Authentication"])
app.include_router(chat.router, prefix="/api", tags=["Chat"])
app.include_router(models.router, prefix="/api", tags=["Models"])
app.include_router(agent_studio.router, prefix="/api", tags=["Agent Studio"])
app.include_router(computer_use.router)
app.include_router(audit.router)


@app.get("/")
async def root():
    """Root endpoint"""
    return {
        "service": "Simon AI Orchestrator",
        "version": "3.1.0",
        "status": "operational",
        "timestamp": datetime.utcnow().isoformat(),
        "docs": "/docs",
        "features": {
            "authentication": settings.DATABASE_URL is not None,
            "persistence": settings.DATABASE_URL is not None,
            "ai_routing": True,
            "streaming": True,
        }
    }


@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    """Global exception handler"""
    logger.error(f"Unhandled exception: {exc}", exc_info=True)
    return JSONResponse(
        status_code=500,
        content={
            "error": "internal_server_error",
            "message": "An unexpected error occurred",
            "request_id": getattr(request.state, "request_id", None),
        }
    )


if __name__ == "__main__":
    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=8000,
        reload=settings.DEBUG,
        log_level=settings.LOG_LEVEL.lower(),
    )
