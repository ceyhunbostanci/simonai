groups:
  - name: simon_ai_alerts
    interval: 30s
    rules:
      # High Error Rate Alert
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) 
            / 
            sum(rate(http_requests_total[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # API Response Time Alert
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
          ) > 2.5
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API latency detected"
          description: "P95 latency is {{ $value }}s (threshold: 2.5s)"

      # Celery Queue Backlog Alert
      - alert: QueueBacklog
        expr: celery_queue_length > 50
        for: 5m
        labels:
          severity: warning
          component: worker
        annotations:
          summary: "Celery queue backlog"
          description: "Queue length is {{ $value }} tasks (threshold: 50)"

      # Memory Usage Alert
      - alert: HighMemoryUsage
        expr: |
          (
            container_memory_usage_bytes{container=~"simon-.*"} 
            / 
            container_spec_memory_limit_bytes{container=~"simon-.*"}
          ) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High memory usage: {{ $labels.container }}"
          description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 80%)"

      # Cost Budget Alert (80%)
      - alert: CostBudgetThreshold
        expr: |
          (
            sum(cost_ledger_total_usd) 
            / 
            100
          ) * 100 > 80
        for: 1h
        labels:
          severity: warning
          component: finance
        annotations:
          summary: "Monthly cost budget at 80%"
          description: "Current spend: ${{ $value | humanize }} / 100 monthly budget"

      # Container Down Alert
      - alert: ContainerDown
        expr: up{job=~"simon-.*"} == 0
        for: 2m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Container {{ $labels.instance }} is down"
          description: "{{ $labels.job }} has been down for more than 2 minutes"

      # Model Failover Rate Alert
      - alert: HighFailoverRate
        expr: |
          rate(model_failover_total[10m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: litellm
        annotations:
          summary: "High model failover rate"
          description: "Failover rate: {{ $value | humanize }} per second"

      # Screenshot Storage Alert (approaching TTL)
      - alert: ScreenshotStorageHigh
        expr: screenshot_storage_bytes > 5e9
        for: 1h
        labels:
          severity: info
          component: storage
        annotations:
          summary: "Screenshot storage approaching limit"
          description: "Current storage: {{ $value | humanize1024 }}B (threshold: 5GB)"
