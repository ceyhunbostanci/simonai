# Simon AI Agent Studio - Egress Proxy Configuration
# Squid Proxy 5.x - Domain Allowlist Enforcement
# 
# CRITICAL SECURITY: Only whitelisted domains are accessible
# All traffic is logged for forensic analysis

# ============================================================
# BASIC CONFIGURATION
# ============================================================
http_port 3128

# Hostname
visible_hostname simon-egress-proxy

# ============================================================
# ACCESS CONTROL LISTS (ACLs)
# ============================================================

# SSL/CONNECT ports
acl SSL_ports port 443
acl Safe_ports port 80          # HTTP
acl Safe_ports port 443         # HTTPS
acl CONNECT method CONNECT

# Allowed domains (loaded from external file)
acl allowed_domains dstdomain "/etc/squid/allowlist.txt"

# ============================================================
# ACCESS RULES
# ============================================================

# Deny requests to non-safe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost

# CRITICAL: Only allow whitelisted domains
http_access allow allowed_domains

# Deny all other requests
http_access deny all

# ============================================================
# LOGGING
# ============================================================

# Access log format (detailed)
logformat combined %>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh

# Enable detailed logging
access_log /var/log/squid/access.log combined
cache_log /var/log/squid/cache.log

# Log denied requests for forensics
log_fqdn on
strip_query_terms off

# ============================================================
# CACHE SETTINGS (Minimal - we're a security proxy)
# ============================================================

# No caching (we're for security, not performance)
cache deny all

# Memory cache
cache_mem 64 MB
maximum_object_size_in_memory 512 KB

# ============================================================
# PERFORMANCE TUNING
# ============================================================

# DNS settings
dns_nameservers 8.8.8.8 8.8.4.4
dns_timeout 10 seconds

# Connection limits
client_lifetime 1 hour
half_closed_clients off

# ============================================================
# SSL/TLS SETTINGS
# ============================================================

# SSL bump configuration (for HTTPS inspection)
# DISABLED in MVP - adds complexity
# sslproxy_cert_error allow all
# ssl_bump splice all

# ============================================================
# HEADERS
# ============================================================

# Forward headers
forwarded_for on
via on

# Custom headers for tracking
request_header_add X-Simon-Proxy "egress-proxy-v1" all

# ============================================================
# ERROR PAGES
# ============================================================

# Custom error pages
error_directory /usr/share/squid/errors/en

# Friendly error messages
deny_info ERR_ACCESS_DENIED allowed_domains

# ============================================================
# PERFORMANCE & LIMITS
# ============================================================

# Request size limits
request_body_max_size 10 MB
reply_body_max_size 100 MB

# Connection limits per client
client_persistent_connections off
server_persistent_connections on

# Timeout settings
connect_timeout 30 seconds
peer_connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds

# ============================================================
# REFRESH PATTERNS (Minimal)
# ============================================================

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# ============================================================
# SECURITY HARDENING
# ============================================================

# Disable unnecessary features
icp_port 0
htcp_port 0

# Disable SNMP
snmp_port 0

# Coredump directory
coredump_dir /var/spool/squid

# ============================================================
# NOTES
# ============================================================
# 
# Allowlist dosyası: /etc/squid/allowlist.txt
# Her satır bir domain:
#   .anthropic.com
#   .openai.com
#   .googleapis.com
#   .github.com
#   .vercel.app
#
# Log rotasyonu için logrotate kullanılmalı
# Production'da Fail2Ban ile abuse koruması önerilir
